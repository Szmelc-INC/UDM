#!/bin/bash
# Modular Dialog Menu
# Szmelc Utils
# Szmelc Utils
# V2 with json support

# Default filenames
CONFIG_FILE="config.json"
TMP_FILE="menu"

# Parse flags for configuration and temporary file names
while getopts "c:t:" opt; do
  case $opt in
    c) CONFIG_FILE="$OPTARG" ;; # Set custom config file
    t) TMP_FILE="$OPTARG" ;;    # Set custom temp file prefix
    *) echo "Usage: $0 [-c config_file] [-t tmp_file_prefix]" >&2; exit 1 ;;
  esac
done

# Temporary filenames
TMP_MENU="${TMP_FILE}.tmp"
TMP_RESULT="${TMP_FILE}.result"

# Check if jq is installed
if ! command -v jq &> /dev/null; then
  echo "Error: jq is required but not installed. Install jq and try again." >&2
  exit 1
fi

# Extract menu title and options from JSON
MENU_TITLE=$(jq -r '.title // "Default Menu Title"' "$CONFIG_FILE")
jq -r '.menu[] | "\(.name)###\(.command)"' "$CONFIG_FILE" > "$TMP_MENU"

# Build an array for dialog menu options
declare -A DIALOG_OPTIONS
while IFS= read -r line; do
    # Split name and command using delimiter ###
    option_name=$(echo "$line" | awk -F '###' '{print $1}')
    option_command=$(echo "$line" | awk -F '###' '{print $2}')
    # Replace spaces in option_name with underscores
    option_name=$(echo "$option_name" | tr ' ' '_')
    DIALOG_OPTIONS["$option_name"]=$option_command
done < "$TMP_MENU"

# Generate dialog command options
DIALOG_CMD="dialog --menu '$MENU_TITLE' 0 0 0"
for option in "${!DIALOG_OPTIONS[@]}"; do
    DIALOG_CMD+=" '$option' ''"
done

# Execute dialog and store the result
eval "$DIALOG_CMD" 2> "$TMP_RESULT"

# Read the selected option
selected_option=$(cat "$TMP_RESULT")

# Execute the selected command
selected_command="${DIALOG_OPTIONS[$selected_option]}"
eval "$selected_command"

# Clean up temporary files
rm -f "$TMP_MENU" "$TMP_RESULT"
